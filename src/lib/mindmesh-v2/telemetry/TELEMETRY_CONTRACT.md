

# Mind Mesh V2 Telemetry Contract

## Overview

The telemetry system is a **privacy-preserving event pipeline** that captures structural patterns and behavior without exposing semantic content.

**Prime Rule:** Mind Mesh emits behaviour. Regulation interprets patterns. Regulation never interprets meaning.

---

## Core Privacy Contract

### FORBIDDEN FIELDS (Never Captured)

The following fields are **strictly forbidden** in telemetry:

#### Content Fields
- ❌ `title` - Container title (semantic content)
- ❌ `body` - Container body (semantic content)
- ❌ `content` - Any textual content
- ❌ `text` - Any text data
- ❌ `label` - Any labels or names
- ❌ `filename` - Any file references

#### Identifier Fields
- ❌ `containerId` - Container IDs (reveals structure)
- ❌ `nodeId` - Node IDs (reveals relationships)
- ❌ `portId` - Port IDs (reveals connections)
- ❌ `trackId` - Guardrails track IDs
- ❌ `taskId` - Guardrails task IDs
- ❌ `entityId` - Any Guardrails entity IDs
- ❌ `referenceId` - Reference IDs
- ❌ `sourcePortId` - Source port IDs
- ❌ `targetPortId` - Target port IDs
- ❌ `parentContainerId` - Parent container IDs
- ❌ `childId` - Child container IDs

#### Position/Dimension Fields
- ❌ `xPosition` / `yPosition` - Exact positions (reveals layout)
- ❌ `width` / `height` - Exact dimensions (reveals sizing)
- ❌ `fromPosition` / `toPosition` - Position deltas
- ❌ `fromDimensions` / `toDimensions` - Dimension deltas

**Rationale:** These fields would allow reconstruction of:
- What the user is thinking about (content)
- What they're working on (references)
- How they've organized it (structure)
- Their spatial arrangements (layout)

---

### ALLOWED FIELDS (Privacy-Safe)

The following fields are **allowed** in telemetry:

#### Core Fields (Required)
- ✅ `id` - Event ID (generated, not meaningful)
- ✅ `workspaceId` - Workspace scope (structural)
- ✅ `userId` - User attribution (for scoping)
- ✅ `eventType` - Event type (categorical)
- ✅ `timestamp` - When event occurred (temporal)

#### Metadata Fields (Optional)
- ✅ `containerType` - `ghost` | `active` (structural state)
- ✅ `relationshipType` - `hierarchy` | `reference` | `custom` | `unknown` (categorical)
- ✅ `direction` - `forward` | `bidirectional` | `reverse` (categorical)
- ✅ `isGhost` - Boolean flag (structural state)
- ✅ `isAutoGenerated` - Boolean flag (source type)
- ✅ `activationReason` - `user_drag` | `user_connect_node` | `user_nest` | `user_explicit` | `cascade_from_parent` (categorical)
- ✅ `sessionDurationMinutes` - Number (aggregate metric)
- ✅ `entityCount` - Number (aggregate count)

**Rationale:** These fields are:
- Categorical (no identifying information)
- Structural (describe form, not content)
- Aggregate (counts, not specifics)
- Boolean flags (state, not meaning)

---

## Allowed Telemetry Event Types

### Container Events (10 types)

```typescript
'ContainerCreated'      // Container was created
'ContainerActivated'    // Ghost became active
'ContainerMoved'        // Container position changed
'ContainerResized'      // Container dimensions changed
'ContainerNested'       // Container nested under parent
'ContainerUnnested'     // Container un-nested (restored to root)
'ContainerConverted'    // Container type changed
'ContainerHidden'       // Container visibility toggled
'ContainerCollapsed'    // Container collapsed/expanded
'ContainerDeleted'      // Container removed
```

### Node Events (5 types)

```typescript
'NodeCreated'           // Node (connection) created
'NodeDeleted'           // Node (connection) deleted
'NodeTypeChanged'       // Node relationship type changed
'NodeDirectionChanged'  // Node direction changed
'NodeHidden'            // Node visibility toggled
```

### Layout Events (4 types)

```typescript
'DefaultLayoutBroken'   // User manually overrode auto-layout
'DefaultLayoutReset'    // User explicitly reset to default layout
'FocusModeEntered'      // User entered focus mode
'FocusModeExited'       // User exited focus mode
```

### Session/Lock Events (4 types)

```typescript
'CanvasLockAcquired'    // User acquired canvas lock
'CanvasLockReleased'    // Canvas lock released
'WorkspaceOpened'       // Workspace opened
'WorkspaceClosed'       // Workspace closed
```

**Total:** 23 event types

---

## Privacy Firewall

The telemetry mapper (`mapper.ts`) acts as a **privacy firewall** that:

1. **Strips all forbidden fields** before persistence
2. **Validates all metadata** against allowed list
3. **Rejects events** with privacy violations
4. **Never logs** content or IDs

### Mapping Process

```
Internal Interaction Event
    ↓ (Enter Privacy Firewall)
mapInteractionEventToTelemetry()
    ↓ (Strip forbidden fields)
Extract allowed metadata only
    ↓ (Validate)
validateTelemetryMeta()
    ↓ (If valid)
Privacy-Safe Telemetry Event
    ↓ (Persist)
Database
```

### Example Mapping

**Input (Interaction Event):**
```typescript
{
  type: 'container_activated',
  containerId: 'abc-123',  // FORBIDDEN
  reason: 'user_drag',
  timestamp: '2025-12-17T10:00:00Z',
  userId: 'user-456'
}
```

**Output (Telemetry Event):**
```typescript
{
  id: 'generated-uuid',
  workspaceId: 'workspace-789',
  userId: 'user-456',
  eventType: 'ContainerActivated',
  timestamp: '2025-12-17T10:00:00Z',
  meta: {
    activationReason: 'user_drag',  // ALLOWED
    isGhost: false                   // ALLOWED
    // containerId STRIPPED
  }
}
```

---

## What Telemetry CANNOT Reveal

### ❌ Cannot Reconstruct Content

Telemetry contains:
- ✅ "Container was activated at 10:00 AM"
- ❌ NOT "Container titled 'Project Alpha' was activated"

### ❌ Cannot Reconstruct Structure

Telemetry contains:
- ✅ "2 nodes were created within 5 minutes"
- ❌ NOT "Node connecting container A to container B was created"

### ❌ Cannot Reconstruct References

Telemetry contains:
- ✅ "Container has relationshipType: hierarchy"
- ❌ NOT "Container references track #42"

### ❌ Cannot Reconstruct Layout

Telemetry contains:
- ✅ "Container was moved"
- ❌ NOT "Container moved from (100, 200) to (300, 400)"

### ❌ Cannot Identify Entities

Telemetry contains:
- ✅ "3 containers activated today"
- ❌ NOT "Containers abc-123, def-456, ghi-789 were activated"

---

## What Telemetry CAN Reveal

### ✅ Activity Patterns (Temporal)

- When user is active (time of day, day of week)
- Session duration (how long they work)
- Activity bursts (rapid sequences of actions)
- Consistency (daily vs sporadic usage)

### ✅ Behavior Patterns (Structural)

- Ghost activation frequency (exploration vs execution)
- Layout break frequency (manual intervention rate)
- Node creation rate (connection-building behavior)
- Nesting patterns (hierarchical organization behavior)

### ✅ Interaction Patterns (Categorical)

- Activation reasons (drag, nest, explicit, etc)
- Relationship types used (hierarchy, reference, custom)
- Lock acquisition patterns (collaboration style)
- Focus mode usage (deep work habits)

**Key Principle:** All patterns are **descriptive**, not **evaluative**.

---

## Aggregation Contract

### ✅ ALLOWED: Descriptive Metrics

Aggregations may provide:

- **Counts**: "15 containers activated today"
- **Frequencies**: "Layout broken 3 times this week"
- **Durations**: "45 minutes in session"
- **Distributions**: "Most active on Tuesdays"
- **Patterns**: "Creation burst detected at 3:00 PM"

### ❌ FORBIDDEN: Evaluative Metrics

Aggregations must NOT provide:

- ❌ **Scores**: "Messiness score: 7/10"
- ❌ **Judgments**: "Too much manual intervention"
- ❌ **Diagnoses**: "User is overwhelmed"
- ❌ **Comparisons**: "More scattered than average user"
- ❌ **Recommendations**: "Should use more hierarchy"

**Rationale:** Evaluation belongs in Regulation layer, not telemetry.

---

## Database Schema

### Table: `mind_mesh_telemetry_events`

```sql
CREATE TABLE mind_mesh_telemetry_events (
  id uuid PRIMARY KEY,
  workspace_id uuid NOT NULL,
  user_id uuid NOT NULL,
  event_type text NOT NULL,
  timestamp timestamptz NOT NULL,
  meta jsonb NOT NULL DEFAULT '{}'::jsonb,
  created_at timestamptz DEFAULT now()
);
```

### Indexes

```sql
-- Workspace queries
CREATE INDEX idx_mm_telemetry_workspace_timestamp
  ON mind_mesh_telemetry_events(workspace_id, timestamp DESC);

-- User queries
CREATE INDEX idx_mm_telemetry_user_timestamp
  ON mind_mesh_telemetry_events(user_id, timestamp DESC);

-- Event type analysis
CREATE INDEX idx_mm_telemetry_event_type_timestamp
  ON mind_mesh_telemetry_events(event_type, timestamp DESC);

-- Date-range queries
CREATE INDEX idx_mm_telemetry_timestamp_only
  ON mind_mesh_telemetry_events(timestamp DESC);
```

### Row Level Security (RLS)

```sql
-- Users can insert their own events
CREATE POLICY "Users can insert own telemetry"
  ON mind_mesh_telemetry_events
  FOR INSERT TO authenticated
  WITH CHECK (auth.uid() = user_id);

-- Users can read their own events
CREATE POLICY "Users can read own telemetry"
  ON mind_mesh_telemetry_events
  FOR SELECT TO authenticated
  USING (auth.uid() = user_id);
```

---

## Usage Examples

### Example 1: Emit from Interaction Event

```typescript
import { emitFromInteractionEvent } from './telemetry';

// Interaction layer emits internal event
const interactionEvent: InteractionEvent = {
  type: 'container_activated',
  containerId: 'abc-123',
  reason: 'user_drag',
  timestamp: new Date().toISOString(),
  userId: 'user-456'
};

// Telemetry layer maps and persists (strips containerId)
await emitFromInteractionEvent(interactionEvent);
// ✅ Stored: { eventType: 'ContainerActivated', activationReason: 'user_drag', ... }
// ❌ NOT stored: containerId
```

---

### Example 2: Manual Session Tracking

```typescript
import { createWorkspaceOpenedEvent, emitTelemetryEvent } from './telemetry';

// When user opens workspace
const openEvent = createWorkspaceOpenedEvent(workspaceId, userId);
if (openEvent) {
  await emitTelemetryEvent(openEvent);
}

// When user closes workspace (track duration)
const sessionMinutes = calculateSessionDuration();
const closeEvent = createWorkspaceClosedEvent(workspaceId, userId, sessionMinutes);
if (closeEvent) {
  await emitTelemetryEvent(closeEvent);
}
```

---

### Example 3: Daily Activity Summary

```typescript
import { getDailyActivitySummary } from './telemetry';

const summary = await getDailyActivitySummary(
  workspaceId,
  userId,
  '2025-12-17'
);

console.log(summary);
// Output:
// {
//   workspaceId: 'workspace-789',
//   userId: 'user-456',
//   date: '2025-12-17',
//   eventCounts: {
//     ContainerActivated: 5,
//     NodeCreated: 3,
//     ContainerMoved: 2
//   },
//   containersActivated: 5,
//   nodesCreated: 3,
//   sessionMinutes: 45,
//   totalEvents: 10
// }
```

---

### Example 4: Weekly Pattern Detection

```typescript
import { getWeeklyPatternSummary } from './telemetry';

const summary = await getWeeklyPatternSummary(
  workspaceId,
  userId,
  '2025-12-10',
  '2025-12-16'
);

console.log(summary);
// Output:
// {
//   workspaceId: 'workspace-789',
//   userId: 'user-456',
//   weekStart: '2025-12-10',
//   weekEnd: '2025-12-16',
//   dailyCounts: [
//     { date: '2025-12-10', eventCount: 12 },
//     { date: '2025-12-11', eventCount: 8 },
//     ...
//   ],
//   creationBursts: [
//     { timestamp: '2025-12-12T15:00:00Z', eventCount: 7 }
//   ],
//   layoutBreaks: 2,
//   totalSessionMinutes: 180,
//   mostActiveDay: '2025-12-10'
// }
```

---

## Integration with Interaction Layer

### Auto-Listening Pattern

```typescript
import { interactionEvents } from './interactions';
import { createTelemetryListener } from './telemetry';

// Create telemetry listener
const telemetryListener = createTelemetryListener();

// Subscribe to interaction events
const unsubscribe = interactionEvents.subscribe(telemetryListener);

// Interaction events now automatically emit telemetry
// (privacy firewall ensures no content leakage)
```

---

### Batch Listening Pattern (High Volume)

```typescript
import { interactionEvents } from './interactions';
import { createBatchTelemetryListener } from './telemetry';

// Create batch listener (10 events or 5 seconds)
const { listener, flush, destroy } = createBatchTelemetryListener(10, 5000);

// Subscribe
const unsubscribe = interactionEvents.subscribe(listener);

// Manually flush when needed
await flush();

// Cleanup
unsubscribe();
destroy();
```

---

## Privacy Assertions (Testing)

### Assert No Forbidden Fields

```typescript
import { assertNoForbiddenFields } from './telemetry';

const telemetryEvent: TelemetryEvent = {
  id: 'uuid',
  workspaceId: 'workspace-789',
  userId: 'user-456',
  eventType: 'ContainerActivated',
  timestamp: '2025-12-17T10:00:00Z',
  meta: { activationReason: 'user_drag' }
};

const check = assertNoForbiddenFields(telemetryEvent);
console.log(check.safe); // true
console.log(check.violations); // []
```

---

### Assert Cannot Reconstruct Graph

```typescript
import { assertCannotReconstructGraph } from './telemetry';

const telemetryEvents: TelemetryEvent[] = [
  // ... array of events
];

const check = assertCannotReconstructGraph(telemetryEvents);
console.log(check.safe); // true
console.log(check.violations); // []
```

---

## GDPR Compliance

### Data Deletion

```typescript
import { deleteTelemetryForUser } from './telemetry';

// Delete all telemetry for user (GDPR right to erasure)
const result = await deleteTelemetryForUser(userId);
console.log(result.deletedCount); // Number of events deleted
```

---

### Data Export

Telemetry is user-readable via Regulation Hub UI (future implementation).
Users can view their own descriptive metrics.

---

## Sanity Checklist

Before deploying telemetry, verify:

✅ **No content fields stored** - Check `meta` contains only allowed fields
✅ **No reference IDs stored** - Check no Guardrails entity IDs
✅ **No container IDs stored** - Check no container/node IDs in telemetry
✅ **Telemetry cannot reconstruct relationships** - Check assertions pass
✅ **Aggregations are descriptive** - Check no scores or judgments
✅ **No UI or recommendation logic** - Check telemetry layer is pure data

---

## Summary

The telemetry system is a **privacy firewall** that:

1. ✅ Captures **structural patterns** and **behavior**
2. ❌ Never captures **content**, **references**, or **relationships**
3. ✅ Provides **descriptive metrics** for Regulation
4. ❌ Never provides **scores**, **judgments**, or **recommendations**
5. ✅ Allows **pattern interpretation** by Regulation layer
6. ❌ Never interprets **meaning** itself

**Core Philosophy:** Emit behavior, not meaning. Describe patterns, not quality.

---

**Document Status:** Complete telemetry contract
**Last Updated:** December 2025
