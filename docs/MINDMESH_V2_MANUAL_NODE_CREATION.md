# Mind Mesh V2 Manual Node Creation

This document describes the manual relationship (node) creation feature in Mind Mesh V2, allowing users to explicitly author relationships between containers.

## Overview

Users with canvas lock can now manually create relationships between containers through an explicit, multi-step workflow:
1. **Activate mode** - Toggle "Create Relationship" mode
2. **Select source** - Click source container
3. **Select target** - Click target container
4. **Choose type** - Explicitly select relationship type
5. **Execute** - System validates, plans, and creates relationship

## Core Interaction Model

### Mode Activation
- **Toolbar Toggle**: "Create Relationship" button
- **Requirements**:
  - User must hold canvas lock
  - Button disabled without lock
- **Visual State**:
  - Green highlight when active
  - Crosshair cursor on canvas
  - Instruction text: "Click source container, then target container"
- **Exit**:
  - Click toggle again
  - Press Escape key

### Container Selection

#### Source Selection
When in relationship mode:
- Click any container to select as source
- Container highlights with:
  - Green background
  - Green border
  - Ring shadow effect
  - Higher z-index
- Ghost line follows cursor from source center

#### Target Selection
After source selected:
- All other containers highlighted as potential targets:
  - Blue background tint
  - Blue border
  - Hover ring effect
- Click different container to select as target
- Clicking same container does nothing

### Relationship Type Selection

After both containers selected:
- Modal appears at click position
- Shows 5 relationship options:
  - **Hierarchy** (blue) - Parent-child ownership
  - **Composition** (dark blue) - Items forming a whole
  - **Dependency** (amber) - Sequential dependencies
  - **Reference** (purple) - Cross-references
  - **Ideation** (green) - Offshoot connections
- Each option shows:
  - Type name
  - Description
  - Color-coded badge
- **No default selection** - user must choose
- Cancel available (button or click outside)

### Execution Flow

On type selection:
1. Modal closes
2. System finds ports for both containers
3. Creates `CreateManualNode` intent with:
   - Source port ID
   - Target port ID
   - Relationship type
   - Direction (forward)
4. Goes through full intent pipeline:
   - Plan generation
   - Validation
   - Execution
   - Telemetry
5. Re-fetches graph state
6. New relationship appears immediately
7. Mode resets (source/target cleared)

## Visual Feedback

### Ghost Line
- Appears after source selection
- Follows cursor in real-time
- Green dashed line
- 60% opacity
- Updates on mouse move
- Scales with viewport zoom

### Container States

#### Normal Container
- White background
- Blue border
- Shadow

#### Source Container (Active)
- Green background (#f0fdf4)
- Green border (#22c55e)
- Ring shadow (green)
- Elevated z-index

#### Valid Target Container
- Blue background tint (#eff6ff)
- Blue border (#3b82f6)
- Hover ring effect (blue)
- Pointer cursor

#### Ghost Container
- Semi-transparent background
- Dashed border
- Can still be selected in relationship mode

### Cursor Feedback
- **Crosshair** - Relationship mode active
- **Pointer** - Over valid target
- **Grab** - Normal canvas interaction
- **Move** - Dragging container (disabled in relationship mode)

## Relationship Properties

All manually created relationships:
- **Manual flag**: `autoGenerated: false`
- **Visual style**: Solid line (not dashed)
- **Thicker line**: 2px base width (vs 1px auto)
- **Source label**: "Created manually in Mind Mesh"
- **Editable**: No (inspection only in this release)
- **Deletable**: No (inspection only in this release)

## Error Handling

### Validation Errors
- **No ports found**: "Containers must have ports to create relationships"
- **Lock lost**: Re-acquire lock to continue
- **Intent failed**: Shows error message verbatim
- **Network error**: Generic failure message

All errors:
- Display in toast/banner
- Auto-dismiss after 5 seconds
- Mode remains active (user can retry)

## Constraints & Rules

### Authority Boundaries
- ✅ Creates manual nodes through proper intent
- ✅ Requires explicit user interaction at every step
- ✅ No inference or automation
- ✅ No modification of existing relationships
- ❌ Cannot create containers as part of flow
- ❌ Cannot delete relationships (yet)
- ❌ Cannot edit relationship type after creation (yet)
- ❌ Cannot create relationships without ports

### Interaction Constraints
- Container dragging disabled in relationship mode
- Canvas panning still works normally
- Cannot select ghost containers for activation
- Cannot create self-referential relationships (source = target)
- Must select two different containers
- Relationship type selection cannot be skipped

### Port Requirements
- Both containers must have ports
- Uses first port found per container
- Will fail if no ports exist
- Auto-generated containers typically have ports
- Manual containers may need port creation first

## Technical Implementation

### Files Created
1. **RelationshipTypeSelector.tsx** - Type selection modal
2. **Updated MindMeshToolbar.tsx** - Mode toggle button
3. **Updated MindMeshCanvasV2.tsx** - Core interaction logic

### State Management
- `relationshipCreationMode` - Mode active flag
- `relationshipSource` - Selected source container
- `relationshipTarget` - Selected target container
- `relationshipGhostLine` - Mouse position for ghost line
- `showRelationshipTypeSelector` - Selector visibility
- `relationshipTypeSelectorPosition` - Selector screen position

### Key Handlers
- `handleToggleRelationshipMode()` - Toggles mode, clears state
- `handleRelationshipContainerClick()` - Selects source/target
- `handleCancelRelationshipCreation()` - Clears selection
- `handleRelationshipTypeSelect()` - Executes intent
- Escape key handler - Cancels creation

### Intent Structure
```typescript
{
  type: 'CreateManualNode',
  sourcePortId: string,
  targetPortId: string,
  relationshipType: RelationshipType,
  relationshipDirection: 'forward'
}
```

## Workflow Examples

### Example 1: Simple Hierarchy
1. User acquires canvas lock
2. Clicks "Create Relationship"
3. Clicks track container (source)
4. Ghost line follows cursor
5. Clicks roadmap item container (target)
6. Modal appears
7. Selects "Hierarchy"
8. Relationship created immediately
9. Solid blue line appears
10. Mode resets

### Example 2: Dependency Between Items
1. User in relationship mode
2. Clicks roadmap item A (source)
3. Clicks roadmap item B (target)
4. Selects "Dependency"
5. Amber line appears
6. Can create another relationship immediately

### Example 3: Cancel Mid-Creation
1. User in relationship mode
2. Clicks source container
3. Realizes mistake
4. Presses Escape
5. Selection cleared
6. Mode still active
7. Can start over

## Future Enhancements (Not Implemented)

The following are explicitly NOT implemented:
- ❌ Port-based dragging (drag from visible port handles)
- ❌ Multi-select for batch creation
- ❌ Relationship editing after creation
- ❌ Relationship deletion
- ❌ AI-suggested relationships
- ❌ Auto-creation based on proximity
- ❌ Relationship templates
- ❌ Keyboard shortcuts for type selection
- ❌ Relationship preview before creation
- ❌ Undo specific relationship (only rollback all)

## Verification Checklist

✅ Relationships can only be created intentionally
✅ Lock is required
✅ Relationship type is always explicit
✅ Manual vs auto distinction is preserved
✅ No backend calls beyond intent execution
✅ No authority leakage to Guardrails
✅ No inference or automation introduced
✅ Ghost line doesn't block pan/zoom
✅ Container dragging disabled in mode
✅ Escape cancels creation
✅ Cursor changes indicate mode
✅ Source container clearly highlighted
✅ Target containers clearly indicated
✅ No optimistic UI
✅ Errors shown verbatim
