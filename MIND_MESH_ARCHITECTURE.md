# Mind Mesh Visual Editor Architecture

## Overview

Mind Mesh is a **visual cognition layer** for Guardrails. It is not a planning tool, not a task system, and not a source of truth. It exists solely to visually represent ideas, relationships, and conceptual structure while automatically reflecting Guardrails hierarchy.

**Core Principle: Guardrails is Authoritative. Mind Mesh Reflects and Annotates Only.**

## Purpose

Mind Mesh serves three primary functions:

1. **Visual Representation**: Display ideas, relationships, and conceptual structure as a graph
2. **Hierarchy Reflection**: Automatically mirror Guardrails tracks, subtracks, and roadmap items
3. **Manual Ideation**: Enable freeform idea creation and connection without affecting authoritative data

Mind Mesh provides explainability ("where did this idea come from?") while maintaining zero write-back to Guardrails.

---

## Core Principles

### 1. Guardrails is Authoritative

- Tracks, subtracks, roadmap items, deadlines, people, and status live in Guardrails
- Mind Mesh reflects and annotates only
- No mutations to Guardrails data
- Any "actions" are navigational or referential only

### 2. Mind Mesh is a Graph Overlay

- **Nodes** = representations of entities or freeform ideas
- **Edges** = conceptual relationships
- Graph ≠ hierarchy (hierarchy is a subset of the graph)

### 3. Automatic + Manual Coexist

- Some nodes/edges are auto-generated from Guardrails
- Others are user-created for ideation
- Auto-generated connections cannot be deleted, only hidden per user
- Manual connections are fully editable

### 4. Zero Write-Back

- Editing Mind Mesh never edits tracks, roadmap items, or personal spaces
- Mind Mesh state is independent of execution systems
- Graph can evolve independently of task/project systems

### 5. User-Specific Visibility

- Hide/show nodes per user without affecting others
- Collapse nodes to simplify view
- Visibility preferences are personal, not global

---

## Node Model

### Node Types

```typescript
type MindMeshSourceType =
  | 'track'          // Main tracks & subtracks
  | 'roadmap_item'   // Tasks, milestones, events, etc.
  | 'idea'           // Freeform user-created
  | 'person'         // Optional, read-only
  | 'document';      // Reference only
```

### Node Structure

```typescript
interface MindMeshNodeExtended {
  id: string;
  masterProjectId: string;

  // Legacy references (optional)
  trackId: string | null;
  subtrackId: string | null;

  // Core fields
  label: string;                  // Display name
  title: string;                  // Legacy field
  content: string;                // Description/notes
  nodeType: string;               // Legacy: idea, task, note, offshoot, group

  // Source reference
  sourceType: MindMeshSourceType | null;
  sourceId: string | null;        // Reference to Guardrails entity

  // Generation metadata
  autoGenerated: boolean;         // True if created from Guardrails
  metadata: Record<string, any>;  // Type-specific data

  // Visual positioning
  xPosition: number;
  yPosition: number;
  width: number;
  height: number;
  color: string;

  // Flags
  isOffshoot: boolean;

  // Timestamps
  createdAt: string;
  updatedAt: string;
}
```

### Node Examples

**Auto-Generated Track Node:**
```json
{
  "id": "abc123",
  "masterProjectId": "proj-1",
  "sourceType": "track",
  "sourceId": "track-xyz",
  "autoGenerated": true,
  "label": "Backend Development",
  "metadata": {
    "color": "#3b82f6",
    "status": "in_progress",
    "parentTrackId": null
  },
  "color": "#3b82f6"
}
```

**Manual Idea Node:**
```json
{
  "id": "def456",
  "masterProjectId": "proj-1",
  "sourceType": "idea",
  "sourceId": null,
  "autoGenerated": false,
  "label": "Consider GraphQL migration",
  "content": "Explore moving from REST to GraphQL for better query flexibility",
  "metadata": {},
  "color": "#f59e0b"
}
```

---

## Edge Model

### Edge Types

```typescript
type MindMeshEdgeType =
  | 'hierarchy'    // Auto: parent track → child subtrack
  | 'reference'    // Auto: roadmap item ↔ track, item ↔ person
  | 'ideation'     // Manual: user-created connection
  | 'influence'    // Manual: directional influence
  | 'derivation'   // Manual: idea → idea
  | 'dependency'   // Legacy
  | 'supporting'   // Legacy
  | 'offshoot';    // Legacy
```

### Edge Structure

```typescript
interface MindMeshEdge {
  id: string;
  fromNodeId: string;
  toNodeId: string;

  // Type
  edgeType: MindMeshEdgeType | null;
  linkType: string;               // Legacy field

  // Direction
  direction: 'directed' | 'undirected';

  // Generation metadata
  autoGenerated: boolean;

  // Optional metadata
  label: string | null;
  weight: number;                 // For future use

  createdAt: string;
}
```

### Edge Rules

**Auto-Generated Edges:**
- Cannot be deleted
- Can be hidden per user via visibility preferences
- Created automatically when Guardrails structure changes
- Examples:
  - Parent track → child subtrack (hierarchy)
  - Track → roadmap items within track (reference)
  - Roadmap item → assigned people (reference)

**Manual Edges:**
- Can be created, edited, or removed by users
- Never affect Guardrails data
- Useful for ideation and conceptual connections
- Examples:
  - Idea → idea (derivation)
  - Idea → track (ideation)
  - Idea → roadmap item (ideation)

---

## Automatic Graph Generation

### Generation Rules

When a project is loaded or structure changes, Mind Mesh auto-generates:

1. **Track Hierarchy**
   - Create node for each track
   - Create hierarchy edges: parent track → child subtrack

2. **Track → Roadmap Item Connections**
   - Create node for each roadmap item
   - Create reference edges: track → items within that track

3. **Roadmap Item → People Connections** (Optional)
   - Create person nodes (read-only)
   - Create reference edges: item → assigned people

4. **Track → Personal Space Links** (Metadata Only)
   - Store metadata but don't render as edges unless toggled

### Auto-Generation Service

```typescript
// Generate full graph from Guardrails structure
const result = await autoGenerateFullGraph(masterProjectId, {
  generateTrackHierarchy: true,
  generateRoadmapItemNodes: true,
  generatePeopleNodes: false,
  generateTrackToItemEdges: true,
  generateItemToPeopleEdges: false
});

// Result
{
  nodesCreated: 42,
  edgesCreated: 68,
  nodesUpdated: 0,
  errors: []
}
```

### Idempotent Generation

- Auto-generation is idempotent
- Running multiple times doesn't create duplicates
- Nodes/edges are matched by source references
- Existing auto-generated nodes are updated, not duplicated

---

## Manual Ideation Layer

### Creating Freeform Idea Nodes

Users can create pure idea nodes that don't reference any Guardrails entity:

```typescript
const ideaNode = await createManualIdeaNode({
  masterProjectId: 'proj-1',
  label: 'Consider microservices architecture',
  content: 'Break down monolith into smaller services',
  xPosition: 100,
  yPosition: 200,
  color: '#f59e0b'
});
```

### Creating Manual Connections

Users can connect any nodes with manual edges:

```typescript
// Idea → Idea (derivation)
await createManualEdge({
  fromNodeId: ideaNode1.id,
  toNodeId: ideaNode2.id,
  edgeType: 'derivation',
  direction: 'directed',
  label: 'led to'
});

// Idea → Track (ideation)
await createManualEdge({
  fromNodeId: ideaNode.id,
  toNodeId: trackNode.id,
  edgeType: 'ideation',
  direction: 'undirected'
});

// Idea → Roadmap Item (influence)
await createManualEdge({
  fromNodeId: ideaNode.id,
  toNodeId: roadmapItemNode.id,
  edgeType: 'influence',
  direction: 'directed',
  label: 'inspired'
});
```

### Constraints on Manual Ideation

**Never Affects Hierarchy:**
- Manual edges don't change track hierarchy
- Manual edges don't change roadmap structure

**Never Affects Execution:**
- Manual ideation doesn't affect deadlines
- Manual ideation doesn't affect task flow
- Manual ideation doesn't affect status

**Can Reference Archived Entities:**
- Manual edges can connect to archived tracks
- Manual edges can connect to completed items
- Useful for historical context

---

## Visibility Control

### Per-User Visibility States

```typescript
type MindMeshVisibilityState = 'visible' | 'hidden' | 'collapsed';
```

**Visible:** Normal display (default)
**Hidden:** User has hidden this node/edge from their view
**Collapsed:** Node is collapsed; children are hidden

### Visibility Operations

```typescript
// Hide a node (user-specific)
await hideNode(userId, masterProjectId, nodeId);

// Show a node
await showNode(userId, masterProjectId, nodeId);

// Collapse a node
await collapseNode(userId, masterProjectId, nodeId);

// Hide an edge
await hideEdge(userId, masterProjectId, edgeId);

// Show an edge
await showEdge(userId, masterProjectId, edgeId);
```

### Bulk Visibility Operations

```typescript
// Hide all auto-generated nodes
await hideAllAutoGeneratedNodes(userId, masterProjectId);

// Show all auto-generated nodes
await showAllAutoGeneratedNodes(userId, masterProjectId);

// Hide specific nodes
await bulkHideNodes(userId, masterProjectId, [nodeId1, nodeId2, nodeId3]);

// Show specific nodes
await bulkShowNodes(userId, masterProjectId, [nodeId1, nodeId2]);
```

### Visibility Filtering

```typescript
// Get hidden nodes for user
const hiddenNodeIds = await getHiddenNodes(userId, masterProjectId);

// Get hidden edges for user
const hiddenEdgeIds = await getHiddenEdges(userId, masterProjectId);

// Filter visible nodes
const visibleNodes = filterVisibleNodes(allNodes, hiddenNodeIds, []);

// Filter visible edges
const visibleEdges = filterVisibleEdges(allEdges, hiddenEdgeIds, hiddenNodeIds);
```

### Key Principle

**Visibility is Personal:**
- Hiding a node affects only the user who hid it
- Other users still see the node
- No global visibility state
- Visibility preferences are stored per user per project

---

## Graph Query Operations

### Get Full Graph

```typescript
const graph = await getFullGraph(masterProjectId, userId);

interface MindMeshGraphData {
  nodes: MindMeshNodeExtended[];
  edges: MindMeshEdge[];
  visibilityPreferences: MindMeshVisibilityPreference[];
}
```

### Filtered Graph Queries

```typescript
const graph = await getFilteredGraph({
  masterProjectId: 'proj-1',
  includeAutoGenerated: true,
  includeManual: true,
  sourceTypes: ['track', 'roadmap_item'],
  edgeTypes: ['hierarchy', 'reference'],
  respectVisibility: true,
  userId: 'user-123'
});
```

### Node Neighbors

```typescript
const neighbors = await getNodeNeighbors(nodeId);

interface NodeNeighbors {
  node: MindMeshNodeExtended;
  incomingEdges: MindMeshEdge[];
  outgoingEdges: MindMeshEdge[];
  incomingNodes: MindMeshNodeExtended[];
  outgoingNodes: MindMeshNodeExtended[];
}
```

### Focused Subgraph

```typescript
// Get N-degree neighbors of a node
const subgraph = await getFocusedSubgraph({
  centerNodeId: 'node-123',
  depth: 2,
  includeAutoGenerated: true,
  includeManual: true
});
```

### Search Nodes

```typescript
const results = await searchNodes(masterProjectId, 'authentication');

interface NodeSearchResult {
  node: MindMeshNodeExtended;
  score: number;                    // 100 (label), 50 (content), 25 (metadata)
  matchType: 'label' | 'content' | 'metadata';
}
```

### Graph Statistics

```typescript
const stats = await getGraphStatistics(masterProjectId);

interface GraphStatistics {
  totalNodes: number;
  autoGeneratedNodes: number;
  manualNodes: number;
  nodesBySourceType: Record<MindMeshSourceType, number>;
  totalEdges: number;
  autoGeneratedEdges: number;
  manualEdges: number;
  edgesByType: Record<MindMeshEdgeType, number>;
  hiddenNodesCount: number;
  hiddenEdgesCount: number;
}
```

### Graph Validation

```typescript
const validation = await validateGraph(masterProjectId);

interface GraphValidationResult {
  isValid: boolean;
  orphanedNodes: MindMeshNodeExtended[];        // Nodes with no connections
  invalidEdges: MindMeshEdge[];                 // Edges with missing nodes
  missingSourceReferences: MindMeshNodeExtended[]; // Nodes referencing deleted Guardrails entities
}
```

---

## Interaction Model (Non-UI)

### Interaction Semantics

**Select Node:**
- Show metadata drawer (read-only for Guardrails entities)
- Display: source type, label, content, metadata
- For manual nodes: allow editing

**Create Idea Node:**
- User clicks "Add Idea"
- Create blank node with user text
- Position at cursor or center

**Drag Connection:**
- User drags from one node to another
- Creates manual ideation edge
- Prompts for edge type and label

**Toggle Layers:**
- Show/hide hierarchy edges
- Show/hide roadmap item nodes
- Show/hide people nodes
- Toggle auto-generated vs manual

**Focus Mode:**
- Center on selected node
- Show N-degrees of connections
- Dim irrelevant nodes

### No Rendering Decisions

This architecture does not specify:
- Canvas rendering engine (D3, Konva, React Flow, etc.)
- Layout algorithms (force-directed, hierarchical, etc.)
- Animation behavior
- Drag physics

These are UI implementation details.

---

## Permission & Visibility Rules

### Project-Level Permissions

- Users can only see nodes belonging to projects they can view
- Inherits from `master_projects` permissions
- Enforced via RLS policies

### Role-Based Operations

**Editors/Owners:**
- Can create manual nodes
- Can create manual edges
- Can delete manual nodes/edges
- Can update node positions
- Cannot delete auto-generated nodes/edges

**Viewers:**
- Read-only access
- Can view graph
- Can toggle visibility (personal preference)
- Cannot create or edit nodes/edges

### Visibility (Hide/Collapse) is Per User

- User A hides a node → only User A sees it hidden
- User B still sees the node
- Visibility state is stored in `mind_mesh_user_visibility` table
- Enforced at query time, not database level

---

## Analytics & Metadata

### Tracked Metrics

**Per Project:**
- Total nodes (auto + manual)
- Auto-generated vs manual ratio
- Nodes by source type
- Edges by type
- Orphaned nodes count
- Invalid references count

**Per User:**
- Hidden nodes count
- Collapsed nodes count
- Manual nodes created
- Manual edges created

### No Insights UI

This architecture collects metadata for future use but does not implement:
- Insights dashboard
- Usage analytics UI
- Graph health scoring
- Recommendations

These are future features.

---

## Database Schema

### Tables

**1. `guardrails_nodes` (Extended)**

Core fields + new fields:
- `source_type` (mind_mesh_source_type)
- `source_id` (uuid, nullable)
- `auto_generated` (boolean)
- `metadata` (jsonb)
- `label` (text)

**2. `guardrails_node_links` (Extended)**

Core fields + new fields:
- `edge_type` (mind_mesh_edge_type)
- `direction` (mind_mesh_edge_direction)
- `auto_generated` (boolean)
- `label` (text, nullable)
- `weight` (double precision)

**3. `mind_mesh_user_visibility` (New)**

Fields:
- `id` (uuid, primary key)
- `user_id` (uuid, references auth.users)
- `master_project_id` (uuid, references master_projects)
- `node_id` (uuid, nullable, references guardrails_nodes)
- `edge_id` (uuid, nullable, references guardrails_node_links)
- `visibility_state` (mind_mesh_visibility_state)
- `created_at`, `updated_at` (timestamptz)

Constraints:
- One of `node_id` or `edge_id` must be set
- Unique per user per node/edge

### Enums

```sql
CREATE TYPE mind_mesh_source_type AS ENUM ('track', 'roadmap_item', 'person', 'document', 'idea');
CREATE TYPE mind_mesh_edge_type AS ENUM ('hierarchy', 'reference', 'ideation', 'influence', 'derivation', 'dependency', 'supporting', 'offshoot');
CREATE TYPE mind_mesh_edge_direction AS ENUM ('directed', 'undirected');
CREATE TYPE mind_mesh_visibility_state AS ENUM ('visible', 'hidden', 'collapsed');
```

### Indexes

**Performance indexes:**
- `idx_nodes_source` on (`source_type`, `source_id`)
- `idx_nodes_auto_generated` on (`master_project_id`, `auto_generated`)
- `idx_node_links_edge_type` on (`edge_type`)
- `idx_node_links_auto_generated` on (`auto_generated`)
- `idx_visibility_user` on (`user_id`, `master_project_id`)
- `idx_visibility_node` on (`node_id`)
- `idx_visibility_edge` on (`edge_id`)

---

## Service Layer Files

### Type Definitions
**File:** `src/lib/guardrails/mindMeshGraphTypes.ts`
- All type definitions
- Node, edge, and visibility types
- Query and result types
- Analytics types

### Auto-Generation Service
**File:** `src/lib/guardrails/mindMeshAutoGenService.ts`
- Auto-generate nodes from tracks
- Auto-generate nodes from roadmap items
- Auto-generate hierarchy edges
- Auto-generate reference edges
- Idempotent generation logic

### Manual Ideation Service
**File:** `src/lib/guardrails/mindMeshManualService.ts`
- Create manual idea nodes
- Create manual edges
- Update manual nodes
- Delete manual nodes/edges
- Bulk operations

### Visibility Control Service
**File:** `src/lib/guardrails/mindMeshVisibilityService.ts`
- Set node/edge visibility per user
- Hide/show/collapse operations
- Get hidden/collapsed entities
- Filter visible nodes/edges
- Bulk visibility operations

### Graph Query Service
**File:** `src/lib/guardrails/mindMeshGraphService.ts`
- Get full graph
- Filtered graph queries
- Node neighbors
- Focused subgraph
- Search nodes
- Graph statistics
- Graph validation

---

## Example Workflows

### Workflow 1: Initial Graph Generation

```typescript
// 1. Auto-generate graph from Guardrails
const result = await autoGenerateFullGraph(masterProjectId, {
  generateTrackHierarchy: true,
  generateRoadmapItemNodes: true,
  generatePeopleNodes: false,
  generateTrackToItemEdges: true,
  generateItemToPeopleEdges: false
});

console.log(`Created ${result.nodesCreated} nodes, ${result.edgesCreated} edges`);

// 2. Load graph with visibility preferences
const graph = await getFullGraph(masterProjectId, userId);

// 3. Apply user visibility preferences
const hiddenNodeIds = await getHiddenNodes(userId, masterProjectId);
const hiddenEdgeIds = await getHiddenEdges(userId, masterProjectId);

const visibleNodes = filterVisibleNodes(graph.nodes, hiddenNodeIds, []);
const visibleEdges = filterVisibleEdges(graph.edges, hiddenEdgeIds, hiddenNodeIds);

// Render visibleNodes and visibleEdges
```

### Workflow 2: Adding Manual Ideation

```typescript
// 1. User creates idea node
const ideaNode = await createManualIdeaNode({
  masterProjectId,
  label: 'Consider Redis caching',
  content: 'Add Redis for session storage and API response caching',
  xPosition: 300,
  yPosition: 400
});

// 2. Find related track node
const trackNodes = await getNodesBySourceType(masterProjectId, 'track');
const backendTrack = trackNodes.find(n => n.label.includes('Backend'));

// 3. Create connection
if (backendTrack) {
  await createManualEdge({
    fromNodeId: ideaNode.id,
    toNodeId: backendTrack.id,
    edgeType: 'ideation',
    direction: 'directed',
    label: 'related to'
  });
}

// 4. Reload graph
const updatedGraph = await getFullGraph(masterProjectId, userId);
```

### Workflow 3: Hiding Auto-Generated Clutter

```typescript
// 1. Get all auto-generated roadmap item nodes
const autoNodes = await getAutoGeneratedNodes(masterProjectId);
const roadmapItemNodes = autoNodes.filter(n => n.sourceType === 'roadmap_item');

// 2. Hide all roadmap item nodes
const nodeIds = roadmapItemNodes.map(n => n.id);
await bulkHideNodes(userId, masterProjectId, nodeIds);

// 3. Reload filtered graph
const filteredGraph = await getFilteredGraph({
  masterProjectId,
  respectVisibility: true,
  userId
});

// Now only tracks and manual ideas are visible
```

### Workflow 4: Focus Mode on Specific Node

```typescript
// 1. User selects a track node
const trackNode = await searchNodes(masterProjectId, 'Backend Development');

if (trackNode.length > 0) {
  const centerNode = trackNode[0].node;

  // 2. Get 2-degree subgraph
  const subgraph = await getFocusedSubgraph({
    centerNodeId: centerNode.id,
    depth: 2,
    includeAutoGenerated: true,
    includeManual: true
  });

  // Render only subgraph.nodes and subgraph.edges
}
```

---

## What This Architecture Does NOT Include

### No UI Implementation
- No canvas rendering engine decisions
- No layout algorithm implementations
- No drag-and-drop implementation
- No animations or transitions
- No styling or theming

### No Visual Renderer
- No D3.js integration
- No Konva integration
- No React Flow integration
- Canvas implementation is future work

### No AI Generation
- No AI-powered node creation
- No AI-powered edge suggestions
- No AI-powered layout optimization
- AI features are future work

### No Automation
- No automatic ideation
- No auto-suggestions
- No background processing
- Automation is future work

### No Permissions UI
- No admin panel for permissions
- No role management UI
- Permissions enforced, not managed

### No Task Editing
- Cannot edit roadmap items from Mind Mesh
- Cannot edit track details
- Cannot change deadlines or status
- Guardrails remains the only editor

---

## Integration Points

### Compatible Systems

✅ **Guardrails Tracks:** Primary source for hierarchy nodes
✅ **Guardrails Roadmap:** Primary source for item nodes
✅ **Project Permissions:** Inherits from master_projects
✅ **Subtracks:** Part of track hierarchy
✅ **Personal Bridge:** Can reference but doesn't integrate directly

### Independent From

- Task Flow (different concern)
- Personal Spaces (different consumption model)
- Focus Mode (different workflow)
- Regulation Engine (different rules)

---

## Future Extensibility

### Ready For (Not Implemented)

**AI-Powered Features:**
- Auto-suggest connections
- Cluster detection
- Anomaly detection (orphaned ideas)

**Layout Algorithms:**
- Force-directed layout
- Hierarchical layout
- Circular layout
- Custom layouts

**Advanced Visualization:**
- Time-based replay
- Diff visualization
- 3D graph rendering

**Collaboration:**
- Real-time co-editing
- Cursor presence
- Comment threads on nodes

---

## Success Criteria

✅ **Mind Mesh reflects Guardrails structure automatically**
- Track hierarchy auto-generates
- Roadmap items auto-generate
- Connections auto-generate

✅ **Manual ideation is possible without data corruption**
- Freeform idea nodes work
- Manual edges work
- No Guardrails mutations occur

✅ **Guardrails remains authoritative**
- No write-back logic exists
- Mind Mesh is read-only mirror + annotation layer
- Source references maintained

✅ **Graph can evolve independently of execution systems**
- Mind Mesh state is separate
- Task Flow unaffected
- Personal Spaces unaffected

✅ **Build passes with zero errors**
- All services type-safe
- Database migration applied
- No compilation errors

✅ **No UI regressions elsewhere**
- Existing UI unaffected
- No breaking changes to other systems

---

## Summary

Mind Mesh is a visual graph overlay that reflects Guardrails structure while enabling manual ideation. It maintains zero write-back to Guardrails, supports per-user visibility preferences, and provides a foundation for future AI and visualization features.

**Key Achievement:** A complete graph architecture that safely represents Guardrails data while enabling user creativity without data corruption.

**Next Steps:** UI implementation can proceed with confidence that the underlying architecture enforces safe graph operations and maintains Guardrails as the single source of truth.
